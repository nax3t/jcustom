---
import { siteConfig } from '../data/siteConfig';

const projectTypes = ['Deck', 'Patio', 'Pergola', 'Outdoor Kitchen', 'Fence', 'Other'];
const timelines = ['Next 3 months', '3-6 months', 'Just exploring'];
---

<section class="py-section px-6 md:px-8" id="contact">
  <div class="max-w-[1318px] mx-auto">
    <div class="text-center mb-20 sm:mb-14">
      <div class="section-label justify-center">
        <span>Get In Touch</span>
      </div>
      <h2 class="font-display text-[clamp(2.5rem,5vw,3.25rem)] leading-[1.15] tracking-[-0.01em] mb-2">
        Inquire Today
      </h2>
      <p class="text-lg text-gray font-sans-alt">
        Let's craft your dream space, together.
      </p>
    </div>

    <!-- Contact Info Cards -->
    <div class="max-w-[900px] mx-auto mb-20 sm:mb-12">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-8">
        <!-- Phone -->
        <div
          x-data
          x-intersect.once="$el.classList.add('animate-fade-in')"
          class="relative pl-[71px] pt-[6px] opacity-0"
        >
          <div class="absolute left-[3px] top-[10px] w-[54px] h-[54px] bg-black flex items-center justify-center">
            <svg class="w-[18px] h-[18px] text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
            </svg>
          </div>
          <div class="text-[22px] font-semibold leading-[1.3] tracking-[-0.02em]">Call Us</div>
          <a
            href={siteConfig.phoneHref}
            class="text-gray font-sans-alt hover:text-black transition-colors"
          >
            {siteConfig.phone}
          </a>
        </div>

        <!-- Address -->
        <div
          x-data="{ mapOpen: false }"
          x-intersect.once="$el.classList.add('animate-fade-in')"
          class="relative pl-[71px] pt-[6px] opacity-0"
          style="animation-delay: 0.1s"
        >
          <div class="absolute left-[3px] top-[10px] w-[54px] h-[54px] bg-black flex items-center justify-center">
            <svg class="w-[18px] h-[18px] text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
          </div>
          <div class="text-[22px] font-semibold leading-[1.3] tracking-[-0.02em]">Address</div>
          <div class="text-gray font-sans-alt">{siteConfig.address.street}</div>
          <div class="mt-[11px]">
            <button
              @click="mapOpen = !mapOpen"
              class="ci-link cursor-pointer bg-transparent border-none p-0"
              x-text="mapOpen ? 'Close Map' : 'See on the Map'"
            ></button>
          </div>
          <div
            x-show="mapOpen"
            x-transition
            class="mt-4 -ml-[71px]"
          >
            <iframe
              title="JCustom Deck and Patio location map"
              src={siteConfig.mapEmbed}
              width="100%"
              height="250"
              style="border: 0"
              allowfullscreen
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
            ></iframe>
          </div>
        </div>

        <!-- Email -->
        <div
          x-data
          x-intersect.once="$el.classList.add('animate-fade-in')"
          class="relative pl-[71px] pt-[6px] opacity-0"
          style="animation-delay: 0.2s"
        >
          <div class="absolute left-[3px] top-[10px] w-[54px] h-[54px] bg-black flex items-center justify-center">
            <svg class="w-[18px] h-[18px] text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
          <div class="text-[22px] font-semibold leading-[1.3] tracking-[-0.02em]">Email</div>
          <a
            href={`mailto:${siteConfig.email}`}
            class="text-gray font-sans-alt hover:text-black transition-colors"
          >
            {siteConfig.email}
          </a>
          <div class="mt-[11px]">
            <a
              href={`mailto:${siteConfig.email}`}
              class="ci-link"
            >
              Say Hello
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Contact Form -->
    <div class="max-w-[900px] mx-auto">
      <form
        x-data="contactForm"
        @submit.prevent="submitForm"
        x-intersect.once="$el.classList.add('animate-fade-up')"
        class="opacity-0"
      >
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
          <div>
            <label for="name" class="block text-[12px] font-semibold uppercase tracking-[0.1em] mb-2 text-gray">Name</label>
            <input
              type="text"
              name="name"
              id="name"
              x-model="form.name"
              placeholder="Enter your name"
              required
              class="w-full px-5 py-4 text-base border border-border bg-transparent focus:outline-none focus:border-black transition-colors"
              :class="errors.name && 'border-accent'"
              @input="errors.name = ''"
            />
          </div>
          <div>
            <label for="email" class="block text-[12px] font-semibold uppercase tracking-[0.1em] mb-2 text-gray">Email</label>
            <input
              type="email"
              name="email"
              id="email"
              x-model="form.email"
              placeholder="Enter your email"
              required
              class="w-full px-5 py-4 text-base border border-border bg-transparent focus:outline-none focus:border-black transition-colors"
              :class="errors.email && 'border-accent'"
              @input="errors.email = ''"
            />
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
          <div>
            <label for="projectType" class="block text-[12px] font-semibold uppercase tracking-[0.1em] mb-2 text-gray">Project Type <span class="normal-case tracking-normal font-normal">(optional)</span></label>
            <select
              name="projectType"
              id="projectType"
              x-model="form.projectType"
              class="w-full px-5 py-4 text-base border border-border bg-transparent focus:outline-none focus:border-black transition-colors"
            >
              <option value="">Select a project type</option>
              {projectTypes.map((type) => (
                <option value={type}>{type}</option>
              ))}
            </select>
          </div>
          <div>
            <label for="timeline" class="block text-[12px] font-semibold uppercase tracking-[0.1em] mb-2 text-gray">Timeline <span class="normal-case tracking-normal font-normal">(optional)</span></label>
            <select
              name="timeline"
              id="timeline"
              x-model="form.timeline"
              class="w-full px-5 py-4 text-base border border-border bg-transparent focus:outline-none focus:border-black transition-colors"
            >
              <option value="">Select a timeline</option>
              {timelines.map((t) => (
                <option value={t}>{t}</option>
              ))}
            </select>
          </div>
        </div>

        <div class="mb-5">
          <label for="message" class="block text-[12px] font-semibold uppercase tracking-[0.1em] mb-2 text-gray">Message</label>
          <textarea
            name="message"
            id="message"
            x-model="form.message"
            placeholder="Enter your message"
            required
            rows="4"
            class="w-full px-5 py-4 text-base border border-border bg-transparent focus:outline-none focus:border-black transition-colors resize-none"
            :class="errors.message && 'border-accent'"
            @input="errors.message = ''"
          ></textarea>
        </div>

        <!-- Honeypot -->
        <div aria-hidden="true" class="absolute -left-[9999px]">
          <input type="text" name="website" x-model="form.website" tabindex="-1" autocomplete="off" />
        </div>

        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
          <div>
            <p class="text-gray text-xs tracking-wide">Name, email, and message are required.</p>
            <p class="text-gray-text text-xs tracking-wide mt-1">We typically respond within 1 business day.</p>
          </div>
          <button
            type="submit"
            :disabled="submitting"
            class="btn btn-primary disabled:opacity-50"
          >
            <span x-text="submitting ? 'Sending...' : 'Submit Message'"></span>
          </button>
        </div>

        <!-- Result -->
        <div
          x-show="resultMessage"
          x-transition
          class="mt-6 text-base"
          :class="resultType === 'success' ? 'text-green-600' : 'text-red-600'"
          role="region"
          aria-live="polite"
        >
          <span x-text="resultMessage"></span>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('contactForm', () => ({
      form: {
        name: '',
        email: '',
        projectType: '',
        timeline: '',
        message: '',
        website: '', // honeypot
      },
      errors: {
        name: '',
        email: '',
        message: '',
      },
      submitting: false,
      resultMessage: '',
      resultType: '',

      validate() {
        let valid = true;
        if (!this.form.name.trim() || this.form.name.length < 3) {
          this.errors.name = 'required';
          valid = false;
        }
        if (
          !this.form.email.trim() ||
          !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.form.email)
        ) {
          this.errors.email = 'required';
          valid = false;
        }
        if (!this.form.message.trim()) {
          this.errors.message = 'required';
          valid = false;
        }
        return valid;
      },

      async submitForm() {
        this.resultMessage = '';

        // Honeypot check
        if (this.form.website) {
          this.resultMessage =
            'Thank you! Your message has been sent.';
          this.resultType = 'success';
          return;
        }

        if (!this.validate()) return;

        this.submitting = true;

        try {
          const res = await fetch('/api/contact', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: this.form.name,
              email: this.form.email,
              projectType: this.form.projectType,
              timeline: this.form.timeline,
              message: this.form.message,
              website: this.form.website,
            }),
          });

          const data = await res.json();
          this.resultMessage = data.text;
          this.resultType = data.type;

          if (data.type === 'success') {
            this.form.name = '';
            this.form.email = '';
            this.form.projectType = '';
            this.form.timeline = '';
            this.form.message = '';
          }
        } catch {
          this.resultMessage =
            'Sorry, there was an error sending your message. Please try again or call us directly.';
          this.resultType = 'error';
        } finally {
          this.submitting = false;
        }
      },
    }));
  });
</script>
