---
import { testimonials } from '../data/testimonials';
---

<section
  class="relative py-section px-6 md:px-8 text-white bg-cover bg-center bg-fixed overflow-hidden grain"
  style="background-image: url('/images/full-width-images/section-bg-2.webp');"
>
  <div class="absolute inset-0 bg-black/75"></div>

  <div class="relative z-10 max-w-[800px] mx-auto">
    <div
      x-data
      x-intersect.once="$el.classList.add('animate-fade-up')"
      class="opacity-0"
    >
      <div class="text-center mb-14 sm:mb-8">
        <div class="section-label section-label-light justify-center mb-4">
          <span>Testimonials</span>
        </div>
        <h2 class="font-display text-[clamp(2.5rem,5vw,3.25rem)] leading-[1.15] tracking-[-0.01em] mb-4">
          What DFW Homeowners Say
        </h2>
        <p class="text-white/50 text-sm font-semibold uppercase tracking-[0.1em]">
          Averaging 5 stars across 50+ reviews
        </p>
      </div>

      <div
        x-data="testimonialCarousel"
        class="relative"
      >
        <!-- Decorative quote mark -->
        <div class="text-center mb-6">
          <span class="font-display text-[80px] leading-none text-white/10 select-none">&ldquo;</span>
        </div>

        <!-- Carousel viewport -->
        <div class="overflow-hidden" x-ref="viewport">
          <div class="flex" x-ref="container">
            {testimonials.map((t) => (
              <div class="flex-[0_0_100%] min-w-0 px-4">
                <blockquote class="text-center">
                  <p class="font-display text-[clamp(1.25rem,3vw,1.625rem)] leading-relaxed tracking-tight italic mb-8">
                    {t.quote}
                  </p>
                  <footer>
                    <span class="text-white/50 text-sm font-semibold uppercase tracking-[0.1em]">
                      {t.author} &bull; {t.project} &bull; {t.source}
                    </span>
                    <div class="flex justify-center gap-1 mt-2">
                      {Array.from({ length: t.stars }).map(() => (
                        <svg class="w-3.5 h-3.5 text-accent" fill="currentColor" viewBox="0 0 20 20">
                          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                        </svg>
                      ))}
                    </div>
                  </footer>
                </blockquote>
              </div>
            ))}
          </div>
        </div>

        <!-- Navigation -->
        <div class="flex justify-center gap-3 mt-12">
          <button
            @click="prev()"
            class="w-10 h-10 border border-white/20 flex items-center justify-center hover:bg-white/10 hover:border-white/40 transition-all duration-300"
            aria-label="Previous testimonial"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7" />
            </svg>
          </button>

          <!-- Dots -->
          {testimonials.map((_, i) => (
            <button
              @click={`goTo(${i})`}
              :class={`selectedIndex === ${i} ? 'bg-white w-6' : 'bg-white/30 w-2'`}
              class="h-2 rounded-full transition-all duration-300"
              aria-label={`Go to testimonial ${i + 1}`}
            />
          ))}

          <button
            @click="next()"
            class="w-10 h-10 border border-white/20 flex items-center justify-center hover:bg-white/10 hover:border-white/40 transition-all duration-300"
            aria-label="Next testimonial"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  import EmblaCarousel from 'embla-carousel';

  document.addEventListener('alpine:init', () => {
    Alpine.data('testimonialCarousel', () => ({
      embla: null as ReturnType<typeof EmblaCarousel> | null,
      selectedIndex: 0,

      init() {
        this.embla = EmblaCarousel(this.$refs.viewport as HTMLElement, {
          loop: true,
          align: 'center',
        });

        this.embla.on('select', () => {
          this.selectedIndex = this.embla!.selectedScrollSnap();
        });
      },

      prev() {
        this.embla?.scrollPrev();
      },
      next() {
        this.embla?.scrollNext();
      },
      goTo(index: number) {
        this.embla?.scrollTo(index);
      },

      destroy() {
        this.embla?.destroy();
      },
    }));
  });
</script>
