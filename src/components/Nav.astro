---
import { Image } from 'astro:assets';
import { navLinks } from '../data/siteConfig';
import logoWhite from '../assets/images/logo-white.webp';
import logoDark from '../assets/images/logo-dark.webp';
---

<nav
  x-data="navBar"
  :class="scrolled ? 'is-scrolled' : ''"
  class="nav-bar fixed top-0 left-0 w-full z-50"
>
  <div class="max-w-[1318px] mx-auto px-6 md:px-8 flex items-center justify-between transition-all duration-300"
       :class="scrolled && !mobileOpen ? 'h-[60px]' : 'h-[85px]'">
    <!-- Logo -->
    <a href="#home" class="relative shrink-0">
      <Image
        src={logoWhite}
        alt="JCustom Deck and Patio Company Logo"
        width={188}
        height={37}
        class="transition-opacity duration-300"
        :class="scrolled ? 'opacity-0 absolute' : 'opacity-100'"
      />
      <Image
        src={logoDark}
        alt="JCustom Deck and Patio Company Logo"
        width={188}
        height={37}
        class="transition-opacity duration-300"
        :class="scrolled ? 'opacity-100' : 'opacity-0 absolute'"
      />
    </a>

    <!-- Mobile Menu Button -->
    <button
      class="lg:hidden p-2 -mr-2"
      @click="mobileOpen = !mobileOpen"
      :aria-expanded="mobileOpen.toString()"
      aria-label="Toggle navigation menu"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              x-show="!mobileOpen" d="M4 6h16M4 12h16M4 18h16" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
              x-show="mobileOpen" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Desktop Nav -->
    <ul class="hidden lg:flex items-center gap-10 text-[13px] font-semibold uppercase tracking-[0.1em]">
      {navLinks.map(({ label, href }) => {
        const section = href.slice(1);
        return (
          <li>
            <a
              href={href}
              class="nav-link relative py-1"
              :class={`{ 'is-active': activeSection === '${section}' }`}
            >
              {label}
              <span
                class="nav-indicator absolute -bottom-0.5 left-0 h-[1.5px] bg-accent"
                :class={`activeSection === '${section}' ? 'w-full' : 'w-0'`}
              ></span>
            </a>
          </li>
        );
      })}
    </ul>
  </div>

  <!-- Mobile Nav -->
  <div
    x-show="mobileOpen"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 -translate-y-2"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 -translate-y-2"
    class="lg:hidden bg-[rgba(17,17,17,.98)]"
    @click.outside="mobileOpen = false"
  >
    <ul class="py-4 px-6">
      {navLinks.map(({ label, href }) => {
        const section = href.slice(1);
        return (
          <li>
            <a
              href={href}
              @click="mobileOpen = false"
              class="mobile-nav-link block py-3 text-[13px] font-semibold uppercase tracking-[0.1em] border-b border-white/5 last:border-0"
              :class={`{ 'is-active': activeSection === '${section}' }`}
            >
              {label}
            </a>
          </li>
        );
      })}
    </ul>
  </div>
</nav>

<style is:global>
  /* Nav bar transitions */
  .nav-bar {
    background: transparent;
    transition: background 0.3s cubic-bezier(0.16, 1, 0.3, 1),
                box-shadow 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .nav-bar.is-scrolled {
    background: rgba(255, 255, 255, 0.99);
    box-shadow: 0 1px 0 rgba(0, 0, 0, 0.06);
  }

  /* Desktop nav link colors — transparent state (over video) */
  .nav-link {
    color: rgba(255, 255, 255, 0.6);
    transition: color 0.2s ease;
  }
  .nav-link:hover {
    color: rgba(255, 255, 255, 1);
  }
  .nav-link.is-active {
    color: white;
  }

  /* Desktop nav link colors — scrolled state (white bg) */
  .is-scrolled .nav-link {
    color: #757575;
  }
  .is-scrolled .nav-link:hover {
    color: #111;
  }
  .is-scrolled .nav-link.is-active {
    color: #111;
  }

  /* Nav indicator line */
  .nav-indicator {
    transition: width 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Mobile menu button inherits from nav state */
  .nav-bar button svg {
    color: white;
    transition: color 0.2s ease;
  }
  .nav-bar.is-scrolled button svg {
    color: #111;
  }

  /* Mobile nav links */
  .mobile-nav-link {
    color: rgba(255, 255, 255, 0.6);
    transition: color 0.2s ease;
  }
  .mobile-nav-link:hover,
  .mobile-nav-link.is-active {
    color: white;
  }
</style>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('navBar', () => ({
      scrolled: false,
      mobileOpen: false,
      activeSection: 'home',

      init() {
        const onScroll = () => {
          this.scrolled = window.scrollY > 50;
        };
        window.addEventListener('scroll', onScroll, { passive: true });
        onScroll();

        // IntersectionObserver for active section
        const sections = document.querySelectorAll('section[id]');
        const observer = new IntersectionObserver(
          (entries) => {
            for (const entry of entries) {
              if (entry.isIntersecting) {
                this.activeSection = entry.target.id;
              }
            }
          },
          { rootMargin: '-40% 0px -55% 0px' }
        );
        sections.forEach((s) => observer.observe(s));
      },
    }));
  });
</script>
